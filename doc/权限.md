# 权限

## 基本原理

本系统是**多个系统的管理者**，一个形象的示例："dmp 系统" 用于管理 京东、淘宝、拼多多的商品、店铺等数据。

因此，对于一个按钮，权限有两层

1. **功能权限**：用户是否有 dmp 某个按钮权限。 例如：小王 是否有 编辑商品信息 的权限。 功能权限包含 rwType 属性，表示此功能是读/写
1. **系统权限**：用户是否有 某个系统的权限，例如：小王 是否有 管理京东的权限

有小王 有 “编辑商品信息”的权限 且有 “京东”的权限，小王点击 “京东这条数据上的编辑” 才能执行操作

## 功能描述

### 功能权限

功能权限 有 N（n>3)层数据， 其中，前 3 层为菜单权限、从第 4 层起为按钮权限（或类似组件）。对于无功能权限的目标，不论是菜单还是按钮，处理方式一律为 **不显示**

| 类型     | 描述                                    |
| -------- | --------------------------------------- |
| 菜单权限 | 菜单实际是根据功能权限的前 3 层数据生成 |
| 按钮权限 | 按钮分散在各个页面，因此需要单独处理    |

### 系统权限

每类系统权限包含两个子类：编辑、查询，不同的按钮对应不同的类别。

#### 示例

假设，数据源列表，有一条数据为京东，对于此条数据

1. 编辑按钮，对应：系统权限中的京东的 _编辑_ 权限
2. 详情按钮，对应：系统权限中的京东的 _查询_ 权限

## 权限的处理过程及几个典型示例

### 过程描述
1. 检查功能权限：使用设置的 *功能码* 到 *权限树* 中查找 *功能结点*，如果有数据且未选中，表示无权限；否则，有权限
2. 检查系统权限：
   1. 从功能权限中获取rwType属性，则系统码 = `系统名称/rwType对应的字符串`，例如:`aaa/view`、`aaa/edit`。
   2. 使用 *系统码* 到 *权限树* 查找 *权限结点*，如果有数据且未选中，表示无权限；否则，有权限

### 单行编辑

#### 场景

数据源列表-->京东这行数据-->编辑

#### 步骤

    1. 检查功能权限： 如果用户无“数据源-->编辑”功能权限，不显示编辑按钮；如果有，显示按钮，并显示系统权限
    2. 检查系统权限： 如果用户无“京东的编辑”权限，弹窗提示用户无权限；如果有，正常执行

### 新建

#### 场景

数据源列表-->创建数据源

#### 步骤

    1. 检查功能权限：同上
    2. 检查系统权限：创建和系统无关，因此不检查系统权限

### 多行编辑

#### 场景

数据源列表-->选择多行-->批量编辑

#### 步骤

    1. 检查功能权限：同上
    2. 检查系统权限：此时，需要检查所有选中系统的系统权限，并分为 2 类“有权限的”：“无权限的”；
    3. 对于已选的系统，如果
        1. 全无权限：提示无权限
        2. 部分有权限：提示哪些有权限，哪些无权限。并对有权限的执行操作
        3. 全有权限：直接执行操作

## 使用

项目中已内置 3 类组件

### 单系统权限包裹器
包裹操作单个系统的显示元素

```xml
<PermissionWrap funcCode='/sys/collect/task/manage/set' systemCode={record.id} onClick={this.onAdd}>
    <Button type='primary'>编辑</Button>
</PermissionWrap>
```

### 多系统权限包裹器
包裹批量操作多系统的显示元素

```xml
<BatchPermissionWrap
    onSuccess={(rows) => {
        update(rows)
        controller.updateSelectedKeys([])
    }}
    funcCode={item.funcCode}
    systemRows={selectedRows}
    rowId='businessId'
    rowLabel='businessName'
>
    <button>批量编辑</button>
</BatchPermissionWrap>
```

### 权限检查函数

```js
// 是否具有功能权限
PermissionManage.hasFuncPermission(funcCode)

// 是否具有权限
PermissionManage.hasPermission({
    funcCode,
    systemCode,
})

// 检查多个系统的权限状况

const result = PermissionManage.batchCheckHasPermission(funcCode, idList)
// hasFunc-是否有功能权限
// systemList--有权限的系统系统列表
const { hasFunc, systemList } = result
```
